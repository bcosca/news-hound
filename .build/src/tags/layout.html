<news:layout tag="cc:basecoat">
  <main tag="cc:main" ref="main">
    <header tag="cc:sheet" class="top" ref="top">
      <div tag="cc:appbar" class="${ props.app.storage.darkMode?'reverse':'primary' }" ref="appbar">
        <span class="title ml-1 mr-auto">
          <img src="pub/img/logo.png" height="20" class="primary">
        </span>
        <button type="button" class="mx-1" ref="darkmode" title="${ props.app.storage.darkMode?'Disable':'Enable' } dark mode"><i class="icon icon-invert-colors infinite"></i></button>
        <button type="button" class="mx-1" ref="reload" title="Refresh"><i class="icon icon-refresh infinite" ref="icon"></i></button>
      </div>
    </header>
    <div tag="cc:progress" class="indeterminate" ref="progress"></div>
    <div class="container" ref="content"></div>
    <footer ref="colophon"></footer>
  </main>
  <style>
  body {
    width:480px;
  }
  html,body {
    scrollbar-color:var(--shaded) transparent;
    scrollbar-width:thin;
  }
  main {
    background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQYV2NkQAKrVq0yZoTxQZywsLCzYAEYB8RmROaABACrOQ42LQKAagAAAABJRU5ErkJggg==);
    background-attachment:fixed;
    background-repeat:repeat;
  }
  p:empty {
    display:none;
  }
  .container {
    transition:opacity .45s linear;
  }
  .container:empty {
    opacity:0;
  }
  .card img {
    background-color:var(--shaded);
  }
  </style>
  <script>
  document.title=props.app.brand;

  let $=roadshow.$,
      self=this,
      api={
        weather:'41d8b0b419d0061751264c1fb64592f0'
      };

  this.once('ready',function() {

    let storage=props.app.storage,
        main=refs.main.expose(),
        reload=refs.icon.expose(),
        progress=refs.progress.expose(),
        content=refs.content.expose();

    function weather() {
      navigator.geolocation.getCurrentPosition(function(pos) {
        let now=Date.now();
        if (!storage.weatherDate || now/1e3-storage.weatherDate>86.4e3) {
          let xhr=new XMLHttpRequest();
          xhr.open(
            'GET',
            'https://api.openweathermap.org/data/2.5/weather?'+
            'lat='+pos.coords.latitude+'&'+
            'lon='+pos.coords.longitude+'&'+
            'units=metric&'+
            'APPID='+api.weather
          );
          xhr.addEventListener('load',function() {
            storage.weatherDate=(now-now%86.4e6)/1e3;
            storage.weatherJSON=xhr.responseText;
            content.insertBefore(document.createElement('div'),content.firstChild);
            self.getRef(content.firstElementChild).
              inject({ item:JSON.parse(storage.weatherJSON) }).
              addTag('news:weather').
              load();
          });
          xhr.send();
        }
        else {
          content.insertBefore(document.createElement('div'),content.firstChild);
          self.getRef(content.firstElementChild).
            inject({ item:JSON.parse(storage.weatherJSON) }).
            addTag('news:weather').
            load();
        }
      });
    }

    function rss() {
      reload.classList.add('spin');
      refs.progress.css({ display:'block' });
      refs.content.empty();
      refs.colophon.empty();
      let xhr=new XMLHttpRequest();
      xhr.open('GET','https://news.google.com/rss');
      xhr.addEventListener('load',function() {
        weather();
        refs.progress.css({ display:'none' });
        reload.classList.remove('spin');
        refs.colophon.
          addTag('news:colophon').
          load();
        let xml=xhr.responseXML,
            stamp=$('lastBuildDate',xml).shift(),
            url=$('channel>link',xml).shift();
        if (!storage.newsXML)
          storage.newsXML=xhr.responseText;
        $('channel>item',xml).forEach(function(item) {
          content.appendChild(document.createElement('div'));
          self.getRef(content.lastElementChild).
            inject({ item }).
            addTag('news:item').
            load();
        });
      });
      xhr.addEventListener('error',function() {
        refs.content.
          addTag('news:offline').
          load();
        if (storage.newsXML) {
          let xml=(new DOMParser).
            parseFromString(storage.newsXML,'application/xml');
          $('channel>item',xml).forEach(function(item) {
            content.appendChild(document.createElement('div'));
            self.getRef(content.lastElementChild).
              inject({ item }).
              addTag('news:item').
              load();
          });
        }
        refs.progress.css({ display:'none' });
        reload.classList.remove('spin');
      });
      xhr.send();
    }

    this.inject({
      layout:this,
      main:refs.main,
      progress:refs.progress
    });

    refs.reload.
      on('click',function() {
        rss();
      }).
      emit('click');

    refs.darkmode.
      on('click',function() {
        if (storage.darkMode)
          delete storage.darkMode;
        else
          storage.darkMode='on';
          window.location.reload();
      });

  });
  </script>
</news:layout>

